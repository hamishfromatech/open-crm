{% extends "base.html" %}

{% block page_title %}Customers{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-card-foreground">Customers</h1>
            <p class="text-muted-foreground">Manage your customer relationships</p>
        </div>
        <button onclick="showCreateModal()" class="btn">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Customer
        </button>
    </div>

    <!-- Search and Filters -->
    <div class="card">
        <header class="pb-4">
            <h3 class="text-lg font-medium text-card-foreground">Search & Filter</h3>
        </header>
        <section>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <label for="search-input" class="label">Search</label>
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Search by name, company, or email..."
                        class="input"
                        onkeyup="filterCustomers()"
                    >
                </div>
                <div class="sm:w-48">
                    <label for="status-filter" class="label">Filter</label>
                    <select id="status-filter" class="select" onchange="filterCustomers()">
                        <option value="">All Customers</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
        </section>
    </div>

    <!-- Customers Table -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="text-sm text-muted-foreground">
            Switch between different views to manage customers efficiently.
        </div>
        <div class="btn-group" role="tablist">
            <button type="button" class="btn" data-view-btn="table" aria-current="true">Table</button>
            <button type="button" class="btn-outline" data-view-btn="kanban">Kanban</button>
            <button type="button" class="btn-outline" data-view-btn="calendar">Calendar</button>
            <button type="button" class="btn-outline" data-view-btn="gantt">Gantt</button>
        </div>
    </div>

    <div class="card" data-view-section="table">
        <header class="pb-4">
            <h3 class="text-lg font-medium text-card-foreground">Customer List</h3>
        </header>
        <section>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Assigned To</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customers-table-body">
                        <!-- Loading skeleton -->
                        <tr>
                            <td><div class="skeleton h-4"></div></td>
                            <td><div class="skeleton h-4"></div></td>
                            <td><div class="skeleton h-4"></div></td>
                            <td><div class="skeleton h-4"></div></td>
                            <td><div class="skeleton h-4"></div></td>
                            <td><div class="skeleton h-4"></div></td>
                        </tr>
                        <tr>
                            <td><div class="skeleton h-4"></div></td>
                            <td><div class="skeleton h-4"></div></td>
                            <td><div class="skeleton h-4"></div></td>
                            <td><div class="skeleton h-4"></div></td>
                            <td><div class="skeleton h-4"></div></td>
                            <td><div class="skeleton h-4"></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <footer class="pt-4 border-t border-border">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-muted-foreground">
                        Showing <span id="start-count">0</span> to <span id="end-count">0</span> of <span id="total-count">0</span> customers
                    </div>
                    <div class="flex gap-2">
                        <button id="prev-page" class="btn-outline" onclick="changePage(-1)" disabled>
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            Previous
                        </button>
                        <button id="next-page" class="btn-outline" onclick="changePage(1)">
                            Next
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </footer>
        </section>
    </div>

    <!-- Customers Kanban -->
    <div class="card hidden" data-view-section="kanban">
        <header class="pb-4 flex items-center justify-between">
            <h3 class="text-lg font-medium text-card-foreground">Customer Segments</h3>
            <span class="text-sm text-muted-foreground">Grouped by status.</span>
        </header>
        <section>
            <div id="customers-kanban" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4"></div>
        </section>
    </div>

    <!-- Customers Calendar -->
    <div class="card hidden" data-view-section="calendar">
        <header class="pb-4 flex items-center justify-between">
            <div>
                <h3 class="text-lg font-medium text-card-foreground" id="customers-calendar-title">Customer Touchpoints</h3>
                <p class="text-sm text-muted-foreground">Upcoming meetings and follow-ups.</p>
            </div>
            <div class="btn-group">
                <button class="btn-outline" id="customers-calendar-prev" aria-label="Previous month">Prev</button>
                <button class="btn-outline" id="customers-calendar-today">Today</button>
                <button class="btn-outline" id="customers-calendar-next" aria-label="Next month">Next</button>
            </div>
        </header>
        <section>
            <div id="customers-calendar" class="grid grid-cols-7 gap-2 text-sm"></div>
        </section>
    </div>

    <!-- Customers Gantt -->
    <div class="card hidden" data-view-section="gantt">
        <header class="pb-4 flex items-center justify-between">
            <h3 class="text-lg font-medium text-card-foreground">Customer Lifecycle</h3>
            <span class="text-sm text-muted-foreground">Track onboarding milestones.</span>
        </header>
        <section>
            <div id="customers-gantt" class="space-y-4"></div>
        </section>
    </div>
</div>

<!-- Create/Edit Customer Modal -->
<dialog id="customer-modal" class="dialog max-w-2xl w-full" aria-labelledby="customer-modal-title">
    <article class="bg-card text-card-foreground border border-border rounded-lg shadow-xl">
        <header class="flex items-start justify-between gap-4 p-6 pb-4">
            <div>
                <h2 id="customer-modal-title" class="text-xl font-bold">Add Customer</h2>
                <p class="text-sm text-muted-foreground">Add customer details or update existing records.</p>
            </div>
            <button type="button" onclick="hideModal()" class="btn-icon-outline" title="Close dialog">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </header>
        <section class="p-6 pt-0">
            <form id="customer-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="grid gap-2">
                        <label for="customer-name" class="label">
                            Name <span class="text-destructive">*</span>
                        </label>
                        <input type="text" id="customer-name" name="name" class="input" required>
                    </div>
                    <div class="grid gap-2">
                        <label for="customer-company" class="label">Company</label>
                        <input type="text" id="customer-company" name="company" class="input">
                    </div>
                    <div class="grid gap-2">
                        <label for="customer-email" class="label">Email</label>
                        <input type="email" id="customer-email" name="email" class="input">
                    </div>
                    <div class="grid gap-2">
                        <label for="customer-phone" class="label">Phone</label>
                        <input type="tel" id="customer-phone" name="phone" class="input">
                    </div>
                    <div class="md:col-span-2 grid gap-2">
                        <label for="customer-address" class="label">Address</label>
                        <textarea id="customer-address" name="address" class="textarea" rows="3"></textarea>
                    </div>
                    <div class="grid gap-2">
                        <label for="customer-website" class="label">Website</label>
                        <input type="url" id="customer-website" name="website" class="input">
                    </div>
                    <div class="grid gap-2">
                        <label for="customer-industry" class="label">Industry</label>
                        <input type="text" id="customer-industry" name="industry" class="input">
                    </div>
                </div>
            </form>
        </section>
        <footer class="flex justify-end gap-3 p-6 pt-0 border-t border-border">
            <button type="button" onclick="hideModal()" class="btn-outline">Cancel</button>
            <button type="submit" form="customer-form" class="btn">Save Customer</button>
        </footer>
    </article>
</dialog>

<!-- Customer Documents Modal -->
<dialog id="customer-documents-modal" class="dialog max-w-2xl w-full" aria-labelledby="customer-documents-title">
    <article class="bg-card text-card-foreground border border-border rounded-lg shadow-xl">
        <header class="flex items-start justify-between gap-4 p-6 pb-4">
            <div>
                <h2 id="customer-documents-title" class="text-xl font-bold">Customer Documents</h2>
                <p class="text-sm text-muted-foreground">Upload and manage documents for this customer.</p>
            </div>
            <button type="button" onclick="closeCustomerDocuments()" class="btn-icon-outline" title="Close dialog">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </header>
        <section class="p-6 pt-0 space-y-4">
            <form id="customer-document-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="grid gap-2">
                        <label for="customer-document-file" class="label">Select File<span class="text-destructive">*</span></label>
                        <input id="customer-document-file" name="file" type="file" class="input" required>
                    </div>
                    <div class="grid gap-2">
                        <label for="customer-document-description" class="label">Description</label>
                        <input id="customer-document-description" name="description" type="text" class="input" placeholder="Optional description">
                    </div>
                </div>
                <button type="submit" class="btn">Upload Document</button>
            </form>

            <div>
                <h3 class="text-lg font-semibold text-card-foreground mb-3">Documents</h3>
                <div id="customer-documents-list" class="space-y-3">
                    <div class="skeleton h-16"></div>
                    <div class="skeleton h-16"></div>
                </div>
            </div>
        </section>
    </article>
</dialog>
{% endblock %}

{% block scripts %}
<script>
let customers = [];
let currentPage = 1;
const itemsPerPage = 10;
let filteredCustomers = [];
const customerModal = document.getElementById('customer-modal');
const customerForm = document.getElementById('customer-form');
const customerModalTitle = document.getElementById('customer-modal-title');
const customerViewButtons = document.querySelectorAll('[data-view-btn]');
const customerViewSections = document.querySelectorAll('[data-view-section]');
const customersKanbanContainer = document.getElementById('customers-kanban');
const customersCalendarTitle = document.getElementById('customers-calendar-title');
const customersCalendarGrid = document.getElementById('customers-calendar');
const customersCalendarPrev = document.getElementById('customers-calendar-prev');
const customersCalendarNext = document.getElementById('customers-calendar-next');
const customersCalendarToday = document.getElementById('customers-calendar-today');
const customersGanttContainer = document.getElementById('customers-gantt');
let customersCalendarReference = new Date();
const customerDocumentsModal = document.getElementById('customer-documents-modal');
const customerDocumentsList = document.getElementById('customer-documents-list');
const customerDocumentForm = document.getElementById('customer-document-form');
let customerDocumentsCustomerId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadCustomers();

    customerViewButtons.forEach(button => {
        button?.addEventListener('click', () => switchCustomerView(button.dataset.viewBtn));
    });

    customersCalendarPrev?.addEventListener('click', () => changeCustomersCalendarMonth(-1));
    customersCalendarNext?.addEventListener('click', () => changeCustomersCalendarMonth(1));
    customersCalendarToday?.addEventListener('click', () => resetCustomersCalendarMonth());
});

async function loadCustomers() {
    try {
        const response = await fetch('/api/customers');
        customers = await response.json();
        filteredCustomers = [...customers];
        displayCustomers();
    } catch (error) {
        console.error('Error loading customers:', error);
        showToast('error', 'Failed to load customers');
    }
}

function displayCustomers() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageCustomers = filteredCustomers.slice(startIndex, endIndex);

    const tbody = document.getElementById('customers-table-body');
    tbody.innerHTML = '';

    if (pageCustomers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8"><div class="text-muted-foreground">No customers found</div></td></tr>';
        updatePagination();
        return;
    }

    pageCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-accent/50 transition-colors';
        row.innerHTML = `
            <td class="font-medium">${customer.name}</td>
            <td class="text-muted-foreground">${customer.company || '-'}</td>
            <td class="text-muted-foreground">${customer.email || '-'}</td>
            <td class="text-muted-foreground">${customer.phone || '-'}</td>
            <td class="text-muted-foreground">${customer.assigned_user || 'Unassigned'}</td>
            <td class="text-right">
                <div class="flex gap-2 justify-end">
                    <button onclick="openCustomerDocuments(${customer.id})" class="btn-icon-outline" title="Documents">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 6V4m0 2c-1.11 0-2.08-.402-2.599-1M12 12v2m0 4v2"></path>
                        </svg>
                    </button>
                    <button onclick="editCustomer(${customer.id})" class="btn-icon-outline" title="Edit">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </button>
                    <button onclick="deleteCustomer(${customer.id})" class="btn-icon-outline" title="Delete">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    updatePagination();

    renderCustomersKanban();
    renderCustomersCalendar();
    renderCustomersGantt();
}

async function openCustomerDocuments(customerId) {
    customerDocumentsCustomerId = customerId;
    customerDocumentForm.reset();
    await loadCustomerDocuments();
    if (typeof customerDocumentsModal.showModal === 'function') {
        customerDocumentsModal.showModal();
    } else {
        customerDocumentsModal.setAttribute('open', '');
    }
}

function closeCustomerDocuments() {
    if (typeof customerDocumentsModal.close === 'function') {
        customerDocumentsModal.close();
    } else {
        customerDocumentsModal.removeAttribute('open');
    }
    customerDocumentsCustomerId = null;
}

async function loadCustomerDocuments() {
    if (!customerDocumentsCustomerId) return;
    try {
        const response = await fetch(`/api/documents?customer_id=${customerDocumentsCustomerId}`);
        const documents = await response.json();
        renderCustomerDocuments(documents);
    } catch (error) {
        console.error('Error loading documents:', error);
        showToast('error', 'Failed to load documents');
    }
}

function renderCustomerDocuments(documents) {
    if (!customerDocumentsList) return;
    if (!documents.length) {
        customerDocumentsList.innerHTML = '<p class="text-muted-foreground text-sm">No documents uploaded yet.</p>';
        return;
    }

    customerDocumentsList.innerHTML = documents.map(doc => `
        <article class="card">
            <div class="card-content flex items-start justify-between gap-4">
                <div class="space-y-1">
                    <p class="font-medium text-card-foreground">${doc.original_filename}</p>
                    <p class="text-xs text-muted-foreground">Uploaded ${formatDateShort(doc.created_at || '')} by ${doc.uploaded_by_name || 'Unknown'} · ${(doc.file_size / 1024).toFixed(1)} KB</p>
                    ${doc.description ? `<p class="text-sm text-muted-foreground">${doc.description}</p>` : ''}
                </div>
                <div class="flex gap-2">
                    <a href="/api/documents/${doc.id}" class="btn-icon-outline" title="Download">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V4"></path>
                        </svg>
                    </a>
                    <button type="button" class="btn-icon-destructive" title="Delete" onclick="deleteCustomerDocument(${doc.id})">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </article>
    `).join('');
}

async function deleteCustomerDocument(documentId) {
    if (!customerDocumentsCustomerId) return;
    if (!confirm('Delete this document?')) return;
    try {
        const response = await fetch(`/api/documents/${documentId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Delete failed');
        showToast('success', 'Document deleted');
        await loadCustomerDocuments();
    } catch (error) {
        console.error('Error deleting document:', error);
        showToast('error', 'Failed to delete document');
    }
}

customerDocumentForm?.addEventListener('submit', async event => {
    event.preventDefault();
    if (!customerDocumentsCustomerId) return;
    const formData = new FormData(customerDocumentForm);
    formData.append('customer_id', customerDocumentsCustomerId);
    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        if (!response.ok) throw new Error('Upload failed');
        showToast('success', 'Document uploaded');
        customerDocumentForm.reset();
        await loadCustomerDocuments();
    } catch (error) {
        console.error('Error uploading document:', error);
        showToast('error', 'Failed to upload document');
    }
});

function updatePagination() {
    const totalPages = Math.ceil(filteredCustomers.length / itemsPerPage);
    document.getElementById('start-count').textContent = filteredCustomers.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
    document.getElementById('end-count').textContent = Math.min(currentPage * itemsPerPage, filteredCustomers.length);
    document.getElementById('total-count').textContent = filteredCustomers.length;

    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
}

function changePage(direction) {
    const totalPages = Math.ceil(filteredCustomers.length / itemsPerPage);
    const newPage = currentPage + direction;

    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        displayCustomers();
    }
}

function filterCustomers() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();

    filteredCustomers = customers.filter(customer => {
        const searchFields = [
            customer.name,
            customer.company,
            customer.email,
            customer.phone
        ].filter(Boolean);

        return searchFields.some(field => field.toLowerCase().includes(searchTerm));
    });

    currentPage = 1;
    displayCustomers();
}

function switchCustomerView(mode) {
    customerViewButtons.forEach(btn => {
        btn.classList.toggle('btn', btn.dataset.viewBtn === mode);
        btn.classList.toggle('btn-outline', btn.dataset.viewBtn !== mode);
        if (btn.dataset.viewBtn === mode) {
            btn.setAttribute('aria-current', 'true');
        } else {
            btn.removeAttribute('aria-current');
        }
    });

    customerViewSections.forEach(section => {
        section.classList.toggle('hidden', section.dataset.viewSection !== mode);
    });

    if (mode === 'kanban') {
        renderCustomersKanban();
    } else if (mode === 'calendar') {
        renderCustomersCalendar();
    } else if (mode === 'gantt') {
        renderCustomersGantt();
    }
}

function groupCustomersByStatus(customerList) {
    return customerList.reduce((acc, customer) => {
        const key = customer.status || (customer.is_active ? 'active' : 'unassigned') || 'unassigned';
        if (!acc[key]) acc[key] = [];
        acc[key].push(customer);
        return acc;
    }, {});
}

function renderCustomersKanban() {
    if (!customersKanbanContainer) return;

    const groups = groupCustomersByStatus(filteredCustomers);
    const statuses = ['active', 'inactive', 'prospect', 'customer', 'unassigned'];

    customersKanbanContainer.innerHTML = statuses.map(status => {
        const cards = groups[status] || [];
        const title = status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ');
        return `
            <section class="card border border-border bg-muted/40">
                <header class="px-4 py-3 border-b border-border flex items-center justify-between">
                    <h4 class="uppercase text-xs font-semibold tracking-wide">${title}</h4>
                    <span class="badge badge-outline">${cards.length}</span>
                </header>
                <div class="p-4 space-y-3">
                    ${cards.map(customer => `
                        <article class="card bg-card text-card-foreground shadow-sm">
                            <div class="card-content space-y-2">
                                <div class="flex items-start justify-between gap-4">
                                    <h5 class="font-medium">${customer.name}</h5>
                                    <span class="text-xs text-muted-foreground">${customer.company || '-'}</span>
                                </div>
                                <p class="text-xs text-muted-foreground">${customer.email || 'No email'}</p>
                                <div class="flex flex-wrap gap-2 text-xs">
                                    ${customer.industry ? `<span class="badge badge-outline">${customer.industry}</span>` : ''}
                                    ${customer.assigned_user ? `<span class="badge badge-secondary">${customer.assigned_user}</span>` : ''}
                                </div>
                            </div>
                        </article>
                    `).join('') || '<p class="text-sm text-muted-foreground">No customers in this segment.</p>'}
                </div>
            </section>
        `;
    }).join('');
}

function changeCustomersCalendarMonth(delta) {
    customersCalendarReference.setMonth(customersCalendarReference.getMonth() + delta);
    renderCustomersCalendar();
}

function resetCustomersCalendarMonth() {
    customersCalendarReference = new Date();
    renderCustomersCalendar();
}

function renderCustomersCalendar() {
    if (!customersCalendarGrid || !customersCalendarTitle) return;

    const reference = new Date(customersCalendarReference.getFullYear(), customersCalendarReference.getMonth(), 1);
    const month = reference.getMonth();
    const year = reference.getFullYear();
    const monthName = reference.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
    customersCalendarTitle.textContent = `Customer Touchpoints · ${monthName}`;

    const firstDayIndex = reference.getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    customersCalendarGrid.innerHTML = '';

    for (let i = 0; i < firstDayIndex; i++) {
        customersCalendarGrid.appendChild(document.createElement('div'));
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'border border-border rounded-lg p-2 min-h-[6rem] flex flex-col gap-2 bg-background/40';
        const date = new Date(year, month, day);
        const isoDate = date.toISOString().split('T')[0];

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between text-xs font-medium text-muted-foreground';
        header.innerHTML = `<span>${day}</span>`;
        cell.appendChild(header);

        const dayCustomers = filteredCustomers.filter(customer => {
            const nextTouch = customer.next_follow_up || customer.next_activity_date || customer.follow_up_date;
            return nextTouch && nextTouch.startsWith(isoDate);
        });

        dayCustomers.forEach(customer => {
            const badge = document.createElement('div');
            badge.className = 'badge badge-outline text-xs flex items-center gap-2';
            badge.innerHTML = `
                <span class="h-2 w-2 rounded-full bg-blue-500"></span>
                <span>${customer.name}</span>
            `;
            cell.appendChild(badge);
        });

        customersCalendarGrid.appendChild(cell);
    }

    if (!customersCalendarGrid.childElementCount) {
        customersCalendarGrid.innerHTML = '<p class="text-sm text-muted-foreground col-span-7">Add follow-up dates to populate this calendar.</p>';
    }
}

function renderCustomersGantt() {
    if (!customersGanttContainer) return;

    const customersWithDates = filteredCustomers.filter(customer => customer.created_at || customer.updated_at);
    customersWithDates.sort((a, b) => new Date(a.created_at || a.updated_at) - new Date(b.created_at || b.updated_at));

    customersGanttContainer.innerHTML = customersWithDates.map(customer => {
        const start = customer.created_at ? new Date(customer.created_at) : new Date();
        const end = customer.updated_at ? new Date(customer.updated_at) : new Date(start.getTime() + (7 * 24 * 60 * 60 * 1000));
        const duration = Math.max(1, Math.round((end - start) / (24 * 60 * 60 * 1000))); 
        return `
            <div class="space-y-2">
                <div class="flex items-center justify-between text-sm text-muted-foreground">
                    <span class="font-medium text-card-foreground">${customer.name}</span>
                    <span>${formatDateShort(start.toISOString())} – ${formatDateShort(end.toISOString())}</span>
                </div>
                <div class="h-2 rounded-full bg-muted">
                    <div class="h-2 rounded-full bg-blue-500" style="width: ${Math.min(100, duration * 5)}%"></div>
                </div>
            </div>
        `;
    }).join('') || '<p class="text-sm text-muted-foreground">Timeline shows once customers have activity history.</p>';
}

function formatDateShort(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
}

function showCreateModal() {
    customerModalTitle.textContent = 'Add Customer';
    customerForm.reset();
    delete customerForm.dataset.customerId;
    if (typeof customerModal.showModal === 'function') {
        customerModal.showModal();
    } else {
        customerModal.setAttribute('open', '');
    }
}

function hideModal() {
    if (typeof customerModal.close === 'function') {
        customerModal.close();
    } else {
        customerModal.removeAttribute('open');
    }
}

async function editCustomer(id) {
    try {
        const response = await fetch(`/api/customers/${id}`);
        const customer = await response.json();

        customerModalTitle.textContent = 'Edit Customer';
        document.getElementById('customer-name').value = customer.name;
        document.getElementById('customer-company').value = customer.company || '';
        document.getElementById('customer-email').value = customer.email || '';
        document.getElementById('customer-phone').value = customer.phone || '';
        document.getElementById('customer-address').value = customer.address || '';
        document.getElementById('customer-website').value = customer.website || '';
        document.getElementById('customer-industry').value = customer.industry || '';

        customerForm.dataset.customerId = id;

        if (typeof customerModal.showModal === 'function') {
            customerModal.showModal();
        } else {
            customerModal.setAttribute('open', '');
        }
    } catch (error) {
        console.error('Error loading customer:', error);
        showToast('error', 'Failed to load customer details');
    }
}

async function deleteCustomer(id) {
    if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/customers/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('success', 'Customer deleted successfully');
            loadCustomers();
        } else {
            showToast('error', 'Failed to delete customer');
        }
    } catch (error) {
        console.error('Error deleting customer:', error);
        showToast('error', 'Failed to delete customer');
    }
}

customerForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const customerData = Object.fromEntries(formData);
    const customerId = this.dataset.customerId;

    try {
        const url = customerId ? `/api/customers/${customerId}` : '/api/customers';
        const method = customerId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(customerData)
        });

        if (response.ok) {
            hideModal();
            showToast('success', `Customer ${customerId ? 'updated' : 'created'} successfully`);
            loadCustomers();
        } else {
            showToast('error', `Failed to ${customerId ? 'update' : 'create'} customer`);
        }
    } catch (error) {
        console.error('Error saving customer:', error);
        showToast('error', 'Failed to save customer');
    }
});
</script>
{% endblock %}

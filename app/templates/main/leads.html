{% extends "base.html" %}

{% block page_title %}Leads{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-card-foreground">Leads</h1>
            <p class="text-muted-foreground">Manage your sales leads</p>
        </div>
        <button onclick="showCreateModal()" class="btn-primary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Lead
        </button>
    </div>

    <!-- Search and Filters -->
    <div class="card">
        <div class="card-content">
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Search leads..."
                        class="input w-full"
                        onkeyup="filterLeads()"
                    >
                </div>
                <div class="flex gap-2">
                    <select id="status-filter" class="select" onchange="filterLeads()">
                        <option value="">All Status</option>
                        <option value="new">New</option>
                        <option value="contacted">Contacted</option>
                        <option value="qualified">Qualified</option>
                        <option value="proposal">Proposal</option>
                        <option value="negotiation">Negotiation</option>
                        <option value="closed_won">Closed Won</option>
                        <option value="closed_lost">Closed Lost</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- View Mode Toggle -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="text-sm text-muted-foreground">
            Choose how you want to visualise your pipeline.
        </div>
        <div class="btn-group" role="tablist">
            <button type="button" class="btn" data-view-btn="table" aria-current="true">Table</button>
            <button type="button" class="btn-outline" data-view-btn="kanban">Kanban</button>
            <button type="button" class="btn-outline" data-view-btn="calendar">Calendar</button>
            <button type="button" class="btn-outline" data-view-btn="gantt">Gantt</button>
        </div>
    </div>

    <!-- Leads Table -->
    <div class="card" data-view-section="table">
        <div class="card-content">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Status</th>
                            <th>Value</th>
                            <th>Customer</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leads-table-body">
                        <!-- Loading skeleton -->
                        <tr>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                        </tr>
                        <tr>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-between mt-4">
                <div class="text-sm text-muted-foreground">
                    Showing <span id="start-count">0</span> to <span id="end-count">0</span> of <span id="total-count">0</span> leads
                </div>
                <div class="flex gap-2">
                    <button id="prev-page" class="btn-outline" onclick="changePage(-1)" disabled>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Previous
                    </button>
                    <button id="next-page" class="btn-outline" onclick="changePage(1)">
                        Next
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leads Kanban -->
    <div class="card hidden" data-view-section="kanban">
        <div class="card-content">
            <div id="leads-kanban" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <!-- Leads Calendar -->
    <div class="card hidden" data-view-section="calendar">
        <div class="card-content">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-card-foreground" id="leads-calendar-title">Upcoming Schedule</h3>
                    <p class="text-sm text-muted-foreground">Based on expected close dates.</p>
                </div>
                <div class="btn-group">
                    <button class="btn-outline" id="leads-calendar-prev" aria-label="Previous month">Prev</button>
                    <button class="btn-outline" id="leads-calendar-today">Today</button>
                    <button class="btn-outline" id="leads-calendar-next" aria-label="Next month">Next</button>
                </div>
            </div>
            <div id="leads-calendar" class="grid grid-cols-7 gap-2 text-sm"></div>
        </div>
    </div>

    <!-- Leads Gantt -->
    <div class="card hidden" data-view-section="gantt">
        <div class="card-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-card-foreground">Pipeline Timeline</h3>
                <span class="text-sm text-muted-foreground">Shows leads with expected close dates.</span>
            </div>
            <div id="leads-gantt" class="space-y-4"></div>
        </div>
    </div>
</div>

<!-- Create/Edit Lead Modal -->
<dialog id="lead-modal" class="dialog max-w-2xl w-full" aria-labelledby="lead-modal-title">
    <article class="bg-card text-card-foreground border border-border rounded-lg shadow-xl">
        <header class="flex items-start justify-between gap-4 p-6 pb-4">
            <div>
                <h2 id="lead-modal-title" class="text-xl font-bold">Add Lead</h2>
                <p class="text-sm text-muted-foreground">Capture lead details to keep your pipeline current.</p>
            </div>
            <button type="button" onclick="hideModal()" class="btn-icon-outline" title="Close dialog">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </header>
        <section class="p-6 pt-0">
            <form id="lead-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label for="lead-title" class="label">Title *</label>
                        <input type="text" id="lead-title" name="title" class="input w-full" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="lead-description" class="label">Description</label>
                        <textarea id="lead-description" name="description" class="textarea w-full" rows="3"></textarea>
                    </div>
                    <div>
                        <label for="lead-source" class="label">Source</label>
                        <select id="lead-source" name="source" class="select w-full">
                            <option value="">Select Source</option>
                            <option value="website">Website</option>
                            <option value="referral">Referral</option>
                            <option value="cold_call">Cold Call</option>
                            <option value="social_media">Social Media</option>
                            <option value="advertising">Advertising</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="lead-status" class="label">Status</label>
                        <select id="lead-status" name="status" class="select w-full" required>
                            <option value="new">New</option>
                            <option value="contacted">Contacted</option>
                            <option value="qualified">Qualified</option>
                            <option value="proposal">Proposal</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="closed_won">Closed Won</option>
                            <option value="closed_lost">Closed Lost</option>
                        </select>
                    </div>
                    <div>
                        <label for="lead-value" class="label">Value ($)</label>
                        <input type="number" id="lead-value" name="value" class="input w-full" step="0.01" min="0">
                    </div>
                    <div>
                        <label for="lead-probability" class="label">Probability (%)</label>
                        <input type="number" id="lead-probability" name="probability" class="input w-full" min="0" max="100" value="0">
                    </div>
                    <div>
                        <label for="lead-customer" class="label">Customer</label>
                        <select id="lead-customer" name="customer_id" class="select w-full">
                            <option value="">Select Customer (Optional)</option>
                        </select>
                    </div>
                    <div>
                        <label for="lead-assigned-user" class="label">Assigned To</label>
                        <select id="lead-assigned-user" name="assigned_user_id" class="select w-full">
                            <option value="">Select User (Optional)</option>
                        </select>
                    </div>
                    <div>
                        <label for="lead-expected-close" class="label">Expected Close Date</label>
                        <input type="date" id="lead-expected-close" name="expected_close_date" class="input w-full">
                    </div>
                </div>
            </form>
        </section>
        <footer class="flex justify-end gap-3 p-6 pt-0 border-t border-border">
            <button type="button" onclick="hideModal()" class="btn-outline">Cancel</button>
            <button type="submit" form="lead-form" class="btn-primary">Save Lead</button>
        </footer>
    </article>
</dialog>
{% endblock %}

{% block scripts %}
<script>
let leads = [];
let customers = [];
let users = [];
let currentPage = 1;
const itemsPerPage = 10;
let filteredLeads = [];
const leadModal = document.getElementById('lead-modal');
const leadForm = document.getElementById('lead-form');
const leadModalTitle = document.getElementById('lead-modal-title');
const leadViewButtons = document.querySelectorAll('[data-view-btn]');
const leadViewSections = document.querySelectorAll('[data-view-section]');
const leadsKanbanContainer = document.getElementById('leads-kanban');
const leadsCalendarTitle = document.getElementById('leads-calendar-title');
const leadsCalendarGrid = document.getElementById('leads-calendar');
const leadsCalendarPrev = document.getElementById('leads-calendar-prev');
const leadsCalendarNext = document.getElementById('leads-calendar-next');
const leadsCalendarToday = document.getElementById('leads-calendar-today');
const leadsGanttContainer = document.getElementById('leads-gantt');
let leadsCalendarReference = new Date();

document.addEventListener('DOMContentLoaded', function() {
    loadLeads();
    loadCustomers();
    loadUsers();

    leadViewButtons.forEach(button => {
        button?.addEventListener('click', () => switchLeadView(button.dataset.viewBtn));
    });

    leadsCalendarPrev?.addEventListener('click', () => changeLeadsCalendarMonth(-1));
    leadsCalendarNext?.addEventListener('click', () => changeLeadsCalendarMonth(1));
    leadsCalendarToday?.addEventListener('click', () => resetLeadsCalendarMonth());
});

async function loadLeads() {
    try {
        const response = await fetch('/api/leads');
        leads = await response.json();
        filteredLeads = [...leads];
        displayLeads();
    } catch (error) {
        console.error('Error loading leads:', error);
        showAlert('Error loading leads', 'error');
    }
}

async function loadCustomers() {
    try {
        const response = await fetch('/api/customers');
        customers = await response.json();
        populateCustomerSelect();
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

async function loadUsers() {
    // For now, we'll use a simple approach - in a real app you'd have a users API
    // For demo purposes, we'll assume some default users
    users = [
        { id: 1, name: 'Admin User' },
        { id: 2, name: 'John Manager' },
        { id: 3, name: 'Jane Employee' }
    ];
    populateUserSelect();
}

function populateCustomerSelect() {
    const select = document.getElementById('lead-customer');
    select.innerHTML = '<option value="">Select Customer (Optional)</option>';
    customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name;
        select.appendChild(option);
    });
}

function populateUserSelect() {
    const select = document.getElementById('lead-assigned-user');
    select.innerHTML = '<option value="">Select User (Optional)</option>';
    users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.name;
        select.appendChild(option);
    });
}

function displayLeads() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageLeads = filteredLeads.slice(startIndex, endIndex);

    const tbody = document.getElementById('leads-table-body');
    tbody.innerHTML = '';

    if (pageLeads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-muted-foreground">No leads found</td></tr>';
        return;
    }

    pageLeads.forEach(lead => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="font-medium">${lead.title}</td>
            <td>
                <span class="badge ${getStatusBadgeClass(lead.status)}">${lead.status.replace('_', ' ').toUpperCase()}</span>
            </td>
            <td>${lead.value ? '$' + lead.value.toLocaleString() : '-'}</td>
            <td>${lead.customer || 'No customer'}</td>
            <td>${lead.assigned_user || 'Unassigned'}</td>
            <td>
                <div class="flex gap-2">
                    <button onclick="editLead(${lead.id})" class="btn-icon-outline" title="Edit">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </button>
                    <button onclick="deleteLead(${lead.id})" class="btn-icon-destructive" title="Delete">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    updatePagination();

    renderLeadsKanban();
    renderLeadsCalendar();
    renderLeadsGantt();
}

function getStatusBadgeClass(status) {
    const statusClasses = {
        'new': 'badge-primary',
        'contacted': 'badge-secondary',
        'qualified': 'badge-outline',
        'proposal': 'badge-outline',
        'negotiation': 'badge-outline',
        'closed_won': 'badge-success',
        'closed_lost': 'badge-destructive'
    };
    return statusClasses[status] || 'badge-outline';
}

function updatePagination() {
    const totalPages = Math.ceil(filteredLeads.length / itemsPerPage);
    document.getElementById('start-count').textContent = filteredLeads.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
    document.getElementById('end-count').textContent = Math.min(currentPage * itemsPerPage, filteredLeads.length);
    document.getElementById('total-count').textContent = filteredLeads.length;

    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
}

function changePage(direction) {
    const totalPages = Math.ceil(filteredLeads.length / itemsPerPage);
    const newPage = currentPage + direction;

    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        displayLeads();
    }
}

function filterLeads() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;

    filteredLeads = leads.filter(lead => {
        const matchesSearch = lead.title.toLowerCase().includes(searchTerm) ||
                             (lead.customer && lead.customer.toLowerCase().includes(searchTerm));

        const matchesStatus = !statusFilter || lead.status === statusFilter;

        return matchesSearch && matchesStatus;
    });

    currentPage = 1;
    displayLeads();
}

function switchLeadView(mode) {
    leadViewButtons.forEach(btn => {
        btn.classList.toggle('btn', btn.dataset.viewBtn === mode);
        btn.classList.toggle('btn-outline', btn.dataset.viewBtn !== mode);
        if (btn.dataset.viewBtn === mode) {
            btn.setAttribute('aria-current', 'true');
        } else {
            btn.removeAttribute('aria-current');
        }
    });

    leadViewSections.forEach(section => {
        section.classList.toggle('hidden', section.dataset.viewSection !== mode);
    });

    if (mode === 'kanban') {
        renderLeadsKanban();
    } else if (mode === 'calendar') {
        renderLeadsCalendar();
    } else if (mode === 'gantt') {
        renderLeadsGantt();
    }
}

function groupLeadsByStatus(leadsList) {
    return leadsList.reduce((acc, lead) => {
        const key = lead.status || 'unknown';
        if (!acc[key]) acc[key] = [];
        acc[key].push(lead);
        return acc;
    }, {});
}

function renderLeadsKanban() {
    if (!leadsKanbanContainer) return;

    const groups = groupLeadsByStatus(filteredLeads);
    const statuses = ['new', 'contacted', 'qualified', 'proposal', 'negotiation', 'closed_won', 'closed_lost'];

    leadsKanbanContainer.innerHTML = statuses.map(status => {
        const columns = groups[status] || [];
        const title = status.replace('_', ' ');
        return `
            <section class="card border border-border bg-muted/40">
                <header class="px-4 py-3 border-b border-border flex items-center justify-between">
                    <h4 class="uppercase text-xs font-semibold tracking-wide">${title}</h4>
                    <span class="badge badge-outline">${columns.length}</span>
                </header>
                <div class="p-4 space-y-3">
                    ${columns.map(lead => `
                        <article class="card bg-card text-card-foreground shadow-sm">
                            <div class="card-content space-y-2">
                                <div class="flex items-start justify-between">
                                    <h5 class="font-medium">${lead.title}</h5>
                                    <span class="text-xs text-muted-foreground">${lead.value ? '$' + lead.value.toLocaleString() : '-'}</span>
                                </div>
                                <p class="text-xs text-muted-foreground">${lead.customer || 'No customer'}</p>
                                <div class="flex flex-wrap gap-2 text-xs">
                                    <span class="badge badge-secondary">${lead.assigned_user || 'Unassigned'}</span>
                                    ${lead.expected_close_date ? `<span class="badge badge-outline">${formatDateShort(lead.expected_close_date)}</span>` : ''}
                                </div>
                            </div>
                        </article>
                    `).join('') || '<p class="text-sm text-muted-foreground">No leads in this stage.</p>'}
                </div>
            </section>
        `;
    }).join('');
}

function changeLeadsCalendarMonth(delta) {
    leadsCalendarReference.setMonth(leadsCalendarReference.getMonth() + delta);
    renderLeadsCalendar();
}

function resetLeadsCalendarMonth() {
    leadsCalendarReference = new Date();
    renderLeadsCalendar();
}

function renderLeadsCalendar() {
    if (!leadsCalendarGrid || !leadsCalendarTitle) return;

    const reference = new Date(leadsCalendarReference.getFullYear(), leadsCalendarReference.getMonth(), 1);
    const month = reference.getMonth();
    const year = reference.getFullYear();
    const monthName = reference.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
    leadsCalendarTitle.textContent = `Upcoming Schedule · ${monthName}`;

    const firstDayIndex = reference.getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    leadsCalendarGrid.innerHTML = '';

    for (let i = 0; i < firstDayIndex; i++) {
        leadsCalendarGrid.appendChild(document.createElement('div'));
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'border border-border rounded-lg p-2 min-h-[6rem] flex flex-col gap-2 bg-background/40';
        const date = new Date(year, month, day);
        const isoDate = date.toISOString().split('T')[0];

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between text-xs font-medium text-muted-foreground';
        header.innerHTML = `<span>${day}</span>`;
        cell.appendChild(header);

        const dayLeads = filteredLeads.filter(lead => lead.expected_close_date && lead.expected_close_date.startsWith(isoDate));

        dayLeads.forEach(lead => {
            const badge = document.createElement('div');
            badge.className = 'badge badge-outline text-xs flex items-center gap-2';
            badge.innerHTML = `
                <span class="h-2 w-2 rounded-full ${getStatusIndicatorClass(lead.status)}"></span>
                <span>${lead.title}</span>
            `;
            cell.appendChild(badge);
        });

        leadsCalendarGrid.appendChild(cell);
    }
}

function getStatusIndicatorClass(status) {
    const map = {
        'new': 'bg-blue-500',
        'contacted': 'bg-purple-500',
        'qualified': 'bg-amber-500',
        'proposal': 'bg-sky-500',
        'negotiation': 'bg-indigo-500',
        'closed_won': 'bg-green-500',
        'closed_lost': 'bg-red-500'
    };
    return map[status] || 'bg-muted-foreground';
}

function renderLeadsGantt() {
    if (!leadsGanttContainer) return;

    const leadsWithDates = filteredLeads.filter(lead => lead.expected_close_date);
    leadsWithDates.sort((a, b) => new Date(a.expected_close_date) - new Date(b.expected_close_date));

    leadsGanttContainer.innerHTML = leadsWithDates.map(lead => {
        const closeDate = new Date(lead.expected_close_date);
        const startDate = lead.created_at ? new Date(lead.created_at) : new Date(closeDate.getTime() - (7 * 24 * 60 * 60 * 1000));
        const duration = Math.max(1, Math.round((closeDate - startDate) / (24 * 60 * 60 * 1000)));
        return `
            <div class="space-y-2">
                <div class="flex items-center justify-between text-sm text-muted-foreground">
                    <span class="font-medium text-card-foreground">${lead.title}</span>
                    <span>${formatDateShort(startDate.toISOString())} – ${formatDateShort(closeDate.toISOString())}</span>
                </div>
                <div class="h-2 rounded-full bg-muted">
                    <div class="h-2 rounded-full ${getStatusBarClass(lead.status)}" style="width: ${Math.min(100, duration * 5)}%"></div>
                </div>
            </div>
        `;
    }).join('') || '<p class="text-sm text-muted-foreground">Add expected close dates to view the timeline.</p>';
}

function formatDateShort(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
}

function getStatusBarClass(status) {
    const map = {
        'new': 'bg-blue-500',
        'contacted': 'bg-purple-500',
        'qualified': 'bg-amber-500',
        'proposal': 'bg-sky-500',
        'negotiation': 'bg-indigo-500',
        'closed_won': 'bg-green-500',
        'closed_lost': 'bg-red-500'
    };
    return map[status] || 'bg-muted-foreground';
}

function showCreateModal() {
    leadModalTitle.textContent = 'Add Lead';
    leadForm.reset();
    delete leadForm.dataset.leadId;
    if (typeof leadModal.showModal === 'function') {
        leadModal.showModal();
    } else {
        leadModal.setAttribute('open', '');
    }
}

function hideModal() {
    if (typeof leadModal.close === 'function') {
        leadModal.close();
    } else {
        leadModal.removeAttribute('open');
    }
}

async function editLead(id) {
    try {
        const response = await fetch(`/api/leads/${id}`);
        const lead = await response.json();

        leadModalTitle.textContent = 'Edit Lead';
        document.getElementById('lead-title').value = lead.title;
        document.getElementById('lead-description').value = lead.description || '';
        document.getElementById('lead-source').value = lead.source || '';
        document.getElementById('lead-status').value = lead.status;
        document.getElementById('lead-value').value = lead.value || '';
        document.getElementById('lead-probability').value = lead.probability || 0;
        document.getElementById('lead-customer').value = lead.customer_id || '';
        document.getElementById('lead-assigned-user').value = lead.assigned_user_id || '';
        document.getElementById('lead-expected-close').value = lead.expected_close_date ? lead.expected_close_date.split('T')[0] : '';

        // Store the lead ID for update
        leadForm.dataset.leadId = id;

        if (typeof leadModal.showModal === 'function') {
            leadModal.showModal();
        } else {
            leadModal.setAttribute('open', '');
        }
    } catch (error) {
        console.error('Error loading lead:', error);
        showAlert('Error loading lead', 'error');
    }
}

async function deleteLead(id) {
    if (!confirm('Are you sure you want to delete this lead?')) {
        return;
    }

    try {
        const response = await fetch(`/api/leads/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showAlert('Lead deleted successfully', 'success');
            loadLeads();
        } else {
            showAlert('Error deleting lead', 'error');
        }
    } catch (error) {
        console.error('Error deleting lead:', error);
        showAlert('Error deleting lead', 'error');
    }
}

leadForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const leadData = Object.fromEntries(formData);

    // Convert expected_close_date to ISO format if provided
    if (leadData.expected_close_date) {
        leadData.expected_close_date = new Date(leadData.expected_close_date).toISOString();
    }

    // Convert empty strings to null for optional fields
    Object.keys(leadData).forEach(key => {
        if (leadData[key] === '') {
            leadData[key] = null;
        }
    });

    const leadId = this.dataset.leadId;

    try {
        const url = leadId ? `/api/leads/${leadId}` : '/api/leads';
        const method = leadId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(leadData)
        });

        if (response.ok) {
            hideModal();
            showAlert(`Lead ${leadId ? 'updated' : 'created'} successfully`, 'success');
            loadLeads();
        } else {
            showAlert(`Error ${leadId ? 'updating' : 'creating'} lead`, 'error');
        }
    } catch (error) {
        console.error('Error saving lead:', error);
        showAlert('Error saving lead', 'error');
    }
});

function showAlert(message, type = 'info') {
    // Simple alert implementation - could be enhanced with better toast notifications
    alert(message);
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block page_title %}Opportunities{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-card-foreground">Opportunities</h1>
            <p class="text-muted-foreground">Manage your sales opportunities</p>
        </div>
        <button onclick="showCreateModal()" class="btn-primary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Opportunity
        </button>
    </div>

    <!-- Search and Filters -->
    <div class="card">
        <div class="card-content">
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Search opportunities..."
                        class="input w-full"
                        onkeyup="filterOpportunities()"
                    >
                </div>
                <div class="flex gap-2">
                    <select id="status-filter" class="select" onchange="filterOpportunities()">
                        <option value="">All Status</option>
                        <option value="open">Open</option>
                        <option value="won">Won</option>
                        <option value="lost">Lost</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- View Mode Toggle -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="text-sm text-muted-foreground">
            Visualise opportunities with the format that fits your workflow.
        </div>
        <div class="btn-group" role="tablist">
            <button type="button" class="btn" data-view-btn="table" aria-current="true">Table</button>
            <button type="button" class="btn-outline" data-view-btn="kanban">Kanban</button>
            <button type="button" class="btn-outline" data-view-btn="calendar">Calendar</button>
            <button type="button" class="btn-outline" data-view-btn="gantt">Gantt</button>
        </div>
    </div>

    <!-- Opportunities Table -->
    <div class="card" data-view-section="table">
        <div class="card-content">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Amount</th>
                            <th>Probability</th>
                            <th>Status</th>
                            <th>Customer</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="opportunities-table-body">
                        <!-- Loading skeleton -->
                        <tr>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                        </tr>
                        <tr>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                            <td><div class="skeleton"></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-between mt-4">
                <div class="text-sm text-muted-foreground">
                    Showing <span id="start-count">0</span> to <span id="end-count">0</span> of <span id="total-count">0</span> opportunities
                </div>
                <div class="flex gap-2">
                    <button id="prev-page" class="btn-outline" onclick="changePage(-1)" disabled>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Previous
                    </button>
                    <button id="next-page" class="btn-outline" onclick="changePage(1)">
                        Next
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Opportunities Kanban -->
    <div class="card hidden" data-view-section="kanban">
        <div class="card-content">
            <div id="opportunities-kanban" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <!-- Opportunities Calendar -->
    <div class="card hidden" data-view-section="calendar">
        <div class="card-content">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-lg font-semibold text-card-foreground" id="opportunities-calendar-title">Closing Calendar</h3>
                    <p class="text-sm text-muted-foreground">Expected close dates by month.</p>
                </div>
                <div class="btn-group">
                    <button class="btn-outline" id="opportunities-calendar-prev" aria-label="Previous month">Prev</button>
                    <button class="btn-outline" id="opportunities-calendar-today">Today</button>
                    <button class="btn-outline" id="opportunities-calendar-next" aria-label="Next month">Next</button>
                </div>
            </div>
            <div id="opportunities-calendar" class="grid grid-cols-7 gap-2 text-sm"></div>
        </div>
    </div>

    <!-- Opportunities Gantt -->
    <div class="card hidden" data-view-section="gantt">
        <div class="card-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-card-foreground">Opportunity Timeline</h3>
                <span class="text-sm text-muted-foreground">Duration from creation to close.</span>
            </div>
            <div id="opportunities-gantt" class="space-y-4"></div>
        </div>
    </div>
</div>

<!-- Create/Edit Opportunity Modal -->
<dialog id="opportunity-modal" class="dialog max-w-2xl w-full" aria-labelledby="opportunity-modal-title">
    <article class="bg-card text-card-foreground border border-border rounded-lg shadow-xl">
        <header class="flex items-start justify-between gap-4 p-6 pb-4">
            <div>
                <h2 id="opportunity-modal-title" class="text-xl font-bold">Add Opportunity</h2>
                <p class="text-sm text-muted-foreground">Track opportunity progress and keep your team aligned.</p>
            </div>
            <button type="button" onclick="hideModal()" class="btn-icon-outline" title="Close dialog">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </header>
        <section class="p-6 pt-0">
            <form id="opportunity-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label for="opportunity-name" class="label">Name *</label>
                        <input type="text" id="opportunity-name" name="name" class="input w-full" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="opportunity-description" class="label">Description</label>
                        <textarea id="opportunity-description" name="description" class="textarea w-full" rows="3"></textarea>
                    </div>
                    <div>
                        <label for="opportunity-amount" class="label">Amount ($) *</label>
                        <input type="number" id="opportunity-amount" name="amount" class="input w-full" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label for="opportunity-probability" class="label">Probability (%)</label>
                        <input type="number" id="opportunity-probability" name="probability" class="input w-full" min="0" max="100" value="0">
                    </div>
                    <div>
                        <label for="opportunity-status" class="label">Status</label>
                        <select id="opportunity-status" name="status" class="select w-full" required>
                            <option value="open">Open</option>
                            <option value="won">Won</option>
                            <option value="lost">Lost</option>
                        </select>
                    </div>
                    <div>
                        <label for="opportunity-customer" class="label">Customer *</label>
                        <select id="opportunity-customer" name="customer_id" class="select w-full" required>
                            <option value="">Select Customer</option>
                        </select>
                    </div>
                    <div>
                        <label for="opportunity-lead" class="label">Related Lead</label>
                        <select id="opportunity-lead" name="lead_id" class="select w-full">
                            <option value="">Select Lead (Optional)</option>
                        </select>
                    </div>
                    <div>
                        <label for="opportunity-assigned-user" class="label">Assigned To</label>
                        <select id="opportunity-assigned-user" name="assigned_user_id" class="select w-full">
                            <option value="">Select User (Optional)</option>
                        </select>
                    </div>
                    <div>
                        <label for="opportunity-expected-close" class="label">Expected Close Date</label>
                        <input type="date" id="opportunity-expected-close" name="expected_close_date" class="input w-full">
                    </div>
                </div>
            </form>
        </section>
        <footer class="flex justify-end gap-3 p-6 pt-0 border-t border-border">
            <button type="button" onclick="hideModal()" class="btn-outline">Cancel</button>
            <button type="submit" form="opportunity-form" class="btn-primary">Save Opportunity</button>
        </footer>
    </article>
</dialog>
{% endblock %}

{% block scripts %}
<script>
let opportunities = [];
let customers = [];
let leads = [];
let users = [];
let currentPage = 1;
const itemsPerPage = 10;
let filteredOpportunities = [];
const opportunityModal = document.getElementById('opportunity-modal');
const opportunityForm = document.getElementById('opportunity-form');
const opportunityModalTitle = document.getElementById('opportunity-modal-title');
const opportunityViewButtons = document.querySelectorAll('[data-view-btn]');
const opportunityViewSections = document.querySelectorAll('[data-view-section]');
const opportunitiesKanbanContainer = document.getElementById('opportunities-kanban');
const opportunitiesCalendarTitle = document.getElementById('opportunities-calendar-title');
const opportunitiesCalendarGrid = document.getElementById('opportunities-calendar');
const opportunitiesCalendarPrev = document.getElementById('opportunities-calendar-prev');
const opportunitiesCalendarNext = document.getElementById('opportunities-calendar-next');
const opportunitiesCalendarToday = document.getElementById('opportunities-calendar-today');
const opportunitiesGanttContainer = document.getElementById('opportunities-gantt');
let opportunitiesCalendarReference = new Date();

document.addEventListener('DOMContentLoaded', function() {
    loadOpportunities();
    loadCustomers();
    loadLeads();
    loadUsers();

    opportunityViewButtons.forEach(button => {
        button?.addEventListener('click', () => switchOpportunityView(button.dataset.viewBtn));
    });

    opportunitiesCalendarPrev?.addEventListener('click', () => changeOpportunitiesCalendarMonth(-1));
    opportunitiesCalendarNext?.addEventListener('click', () => changeOpportunitiesCalendarMonth(1));
    opportunitiesCalendarToday?.addEventListener('click', () => resetOpportunitiesCalendarMonth());
});

async function loadOpportunities() {
    try {
        const response = await fetch('/api/opportunities');
        opportunities = await response.json();
        filteredOpportunities = [...opportunities];
        displayOpportunities();
    } catch (error) {
        console.error('Error loading opportunities:', error);
        showAlert('Error loading opportunities', 'error');
    }
}

async function loadCustomers() {
    try {
        const response = await fetch('/api/customers');
        customers = await response.json();
        populateCustomerSelect();
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

async function loadLeads() {
    try {
        const response = await fetch('/api/leads');
        leads = await response.json();
        populateLeadSelect();
    } catch (error) {
        console.error('Error loading leads:', error);
    }
}

async function loadUsers() {
    // For demo purposes, using hardcoded users
    users = [
        { id: 1, name: 'Admin User' },
        { id: 2, name: 'John Manager' },
        { id: 3, name: 'Jane Employee' }
    ];
    populateUserSelect();
}

function populateCustomerSelect() {
    const select = document.getElementById('opportunity-customer');
    select.innerHTML = '<option value="">Select Customer</option>';
    customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name;
        select.appendChild(option);
    });
}

function populateLeadSelect() {
    const select = document.getElementById('opportunity-lead');
    select.innerHTML = '<option value="">Select Lead (Optional)</option>';
    leads.forEach(lead => {
        const option = document.createElement('option');
        option.value = lead.id;
        option.textContent = lead.title;
        select.appendChild(option);
    });
}

function populateUserSelect() {
    const select = document.getElementById('opportunity-assigned-user');
    select.innerHTML = '<option value="">Select User (Optional)</option>';
    users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.name;
        select.appendChild(option);
    });
}

function displayOpportunities() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageOpportunities = filteredOpportunities.slice(startIndex, endIndex);

    const tbody = document.getElementById('opportunities-table-body');
    tbody.innerHTML = '';

    if (pageOpportunities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-muted-foreground">No opportunities found</td></tr>';
        return;
    }

    pageOpportunities.forEach(opportunity => {
        const amount = typeof opportunity.amount === 'number' ? opportunity.amount.toLocaleString() : '-';
        const probability = typeof opportunity.probability === 'number' ? opportunity.probability : 0;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="font-medium">${opportunity.name}</td>
            <td>${amount === '-' ? '-' : '$' + amount}</td>
            <td>
                <div class="flex items-center gap-2">
                    <div class="w-16 bg-muted rounded-full h-2">
                        <div class="bg-primary h-2 rounded-full" style="width: ${probability}%"></div>
                    </div>
                    <span class="text-sm">${probability}%</span>
                </div>
            </td>
            <td>
                <span class="badge ${getStatusBadgeClass(opportunity.status)}">${(opportunity.status || '').toUpperCase()}</span>
            </td>
            <td>${opportunity.customer || 'No customer'}</td>
            <td>${opportunity.assigned_user || 'Unassigned'}</td>
            <td>
                <div class="flex gap-2">
                    <button onclick="editOpportunity(${opportunity.id})" class="btn-icon-outline" title="Edit">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </button>
                    <button onclick="deleteOpportunity(${opportunity.id})" class="btn-icon-destructive" title="Delete">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    updatePagination();

    renderOpportunitiesKanban();
    renderOpportunitiesCalendar();
    renderOpportunitiesGantt();
}

function getStatusBadgeClass(status) {
    const statusClasses = {
        'open': 'badge-primary',
        'won': 'badge-success',
        'lost': 'badge-destructive'
    };
    return statusClasses[status] || 'badge-outline';
}

function updatePagination() {
    const totalPages = Math.ceil(filteredOpportunities.length / itemsPerPage);
    document.getElementById('start-count').textContent = filteredOpportunities.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
    document.getElementById('end-count').textContent = Math.min(currentPage * itemsPerPage, filteredOpportunities.length);
    document.getElementById('total-count').textContent = filteredOpportunities.length;

    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
}

function changePage(direction) {
    const totalPages = Math.ceil(filteredOpportunities.length / itemsPerPage);
    const newPage = currentPage + direction;

    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        displayOpportunities();
    }
}

function filterOpportunities() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;

    filteredOpportunities = opportunities.filter(opportunity => {
        const matchesSearch = opportunity.name.toLowerCase().includes(searchTerm) ||
                             (opportunity.customer && opportunity.customer.toLowerCase().includes(searchTerm));

        const matchesStatus = !statusFilter || opportunity.status === statusFilter;

        return matchesSearch && matchesStatus;
    });

    currentPage = 1;
    displayOpportunities();
}

function switchOpportunityView(mode) {
    opportunityViewButtons.forEach(btn => {
        btn.classList.toggle('btn', btn.dataset.viewBtn === mode);
        btn.classList.toggle('btn-outline', btn.dataset.viewBtn !== mode);
        if (btn.dataset.viewBtn === mode) {
            btn.setAttribute('aria-current', 'true');
        } else {
            btn.removeAttribute('aria-current');
        }
    });

    opportunityViewSections.forEach(section => {
        section.classList.toggle('hidden', section.dataset.viewSection !== mode);
    });

    if (mode === 'kanban') {
        renderOpportunitiesKanban();
    } else if (mode === 'calendar') {
        renderOpportunitiesCalendar();
    } else if (mode === 'gantt') {
        renderOpportunitiesGantt();
    }
}

function groupOpportunitiesByStatus(list) {
    return list.reduce((acc, opportunity) => {
        const key = opportunity.status || 'unspecified';
        if (!acc[key]) acc[key] = [];
        acc[key].push(opportunity);
        return acc;
    }, {});
}

function renderOpportunitiesKanban() {
    if (!opportunitiesKanbanContainer) return;

    const groups = groupOpportunitiesByStatus(filteredOpportunities);
    const statuses = ['open', 'won', 'lost', 'unspecified'];

    opportunitiesKanbanContainer.innerHTML = statuses.map(status => {
        const cards = groups[status] || [];
        const title = status === 'unspecified' ? 'Unspecified' : status.charAt(0).toUpperCase() + status.slice(1);
        return `
            <section class="card border border-border bg-muted/40">
                <header class="px-4 py-3 border-b border-border flex items-center justify-between">
                    <h4 class="uppercase text-xs font-semibold tracking-wide">${title}</h4>
                    <span class="badge badge-outline">${cards.length}</span>
                </header>
                <div class="p-4 space-y-3">
                    ${cards.map(opportunity => `
                        <article class="card bg-card text-card-foreground shadow-sm">
                            <div class="card-content space-y-2">
                                <div class="flex items-start justify-between">
                                    <h5 class="font-medium">${opportunity.name}</h5>
                                    <span class="text-xs text-muted-foreground">${opportunity.amount ? '$' + Number(opportunity.amount).toLocaleString() : '-'}</span>
                                </div>
                                <p class="text-xs text-muted-foreground">${opportunity.customer || 'No customer'}</p>
                                <div class="flex flex-wrap gap-2 text-xs">
                                    <span class="badge badge-secondary">${opportunity.assigned_user || 'Unassigned'}</span>
                                    ${opportunity.expected_close_date ? `<span class="badge badge-outline">${formatDateShort(opportunity.expected_close_date)}</span>` : ''}
                                </div>
                            </div>
                        </article>
                    `).join('') || '<p class="text-sm text-muted-foreground">No opportunities in this status.</p>'}
                </div>
            </section>
        `;
    }).join('');
}

function changeOpportunitiesCalendarMonth(delta) {
    opportunitiesCalendarReference.setMonth(opportunitiesCalendarReference.getMonth() + delta);
    renderOpportunitiesCalendar();
}

function resetOpportunitiesCalendarMonth() {
    opportunitiesCalendarReference = new Date();
    renderOpportunitiesCalendar();
}

function renderOpportunitiesCalendar() {
    if (!opportunitiesCalendarGrid || !opportunitiesCalendarTitle) return;

    const reference = new Date(opportunitiesCalendarReference.getFullYear(), opportunitiesCalendarReference.getMonth(), 1);
    const month = reference.getMonth();
    const year = reference.getFullYear();
    const monthName = reference.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
    opportunitiesCalendarTitle.textContent = `Closing Calendar · ${monthName}`;

    const firstDayIndex = reference.getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    opportunitiesCalendarGrid.innerHTML = '';

    for (let i = 0; i < firstDayIndex; i++) {
        opportunitiesCalendarGrid.appendChild(document.createElement('div'));
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'border border-border rounded-lg p-2 min-h-[6rem] flex flex-col gap-2 bg-background/40';
        const date = new Date(year, month, day);
        const isoDate = date.toISOString().split('T')[0];

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between text-xs font-medium text-muted-foreground';
        header.innerHTML = `<span>${day}</span>`;
        cell.appendChild(header);

        const dayOpportunities = filteredOpportunities.filter(opportunity => opportunity.expected_close_date && opportunity.expected_close_date.startsWith(isoDate));

        dayOpportunities.forEach(opportunity => {
            const badge = document.createElement('div');
            badge.className = 'badge badge-outline text-xs flex items-center gap-2';
            badge.innerHTML = `
                <span class="h-2 w-2 rounded-full ${getStatusIndicatorClass(opportunity.status)}"></span>
                <span>${opportunity.name}</span>
            `;
            cell.appendChild(badge);
        });

        opportunitiesCalendarGrid.appendChild(cell);
    }
}

function renderOpportunitiesGantt() {
    if (!opportunitiesGanttContainer) return;

    const items = filteredOpportunities.filter(opportunity => opportunity.expected_close_date || opportunity.created_at || opportunity.updated_at);
    items.sort((a, b) => new Date(a.expected_close_date || a.created_at || a.updated_at || Date.now()) - new Date(b.expected_close_date || b.created_at || b.updated_at || Date.now()));

    opportunitiesGanttContainer.innerHTML = items.map(opportunity => {
        const closeDate = new Date(opportunity.expected_close_date || opportunity.updated_at || opportunity.created_at || Date.now());
        const startDate = opportunity.created_at ? new Date(opportunity.created_at) : new Date(closeDate.getTime() - (7 * 24 * 60 * 60 * 1000));
        const duration = Math.max(1, Math.round((closeDate - startDate) / (24 * 60 * 60 * 1000)));
        return `
            <div class="space-y-2">
                <div class="flex items-center justify-between text-sm text-muted-foreground">
                    <span class="font-medium text-card-foreground">${opportunity.name}</span>
                    <span>${formatDateShort(startDate.toISOString())} – ${formatDateShort(closeDate.toISOString())}</span>
                </div>
                <div class="h-2 rounded-full bg-muted">
                    <div class="h-2 rounded-full ${getStatusBarClass(opportunity.status)}" style="width: ${Math.min(100, duration * 5)}%"></div>
                </div>
            </div>
        `;
    }).join('') || '<p class="text-sm text-muted-foreground">Add creation and close dates to see the opportunity timeline.</p>';
}

function formatDateShort(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
}

function getStatusIndicatorClass(status) {
    const map = {
        'open': 'bg-blue-500',
        'won': 'bg-green-500',
        'lost': 'bg-red-500'
    };
    return map[status] || 'bg-muted-foreground';
}

function getStatusBarClass(status) {
    const map = {
        'open': 'bg-blue-500',
        'won': 'bg-green-500',
        'lost': 'bg-red-500'
    };
    return map[status] || 'bg-muted-foreground';
}

function showCreateModal() {
    opportunityModalTitle.textContent = 'Add Opportunity';
    opportunityForm.reset();
    delete opportunityForm.dataset.opportunityId;
    if (typeof opportunityModal.showModal === 'function') {
        opportunityModal.showModal();
    } else {
        opportunityModal.setAttribute('open', '');
    }
}

function hideModal() {
    if (typeof opportunityModal.close === 'function') {
        opportunityModal.close();
    } else {
        opportunityModal.removeAttribute('open');
    }
}

async function editOpportunity(id) {
    try {
        const response = await fetch(`/api/opportunities/${id}`);
        const opportunity = await response.json();

        opportunityModalTitle.textContent = 'Edit Opportunity';
        document.getElementById('opportunity-name').value = opportunity.name;
        document.getElementById('opportunity-description').value = opportunity.description || '';
        document.getElementById('opportunity-amount').value = opportunity.amount;
        document.getElementById('opportunity-probability').value = opportunity.probability || 0;
        document.getElementById('opportunity-status').value = opportunity.status;
        document.getElementById('opportunity-customer').value = opportunity.customer_id || '';
        document.getElementById('opportunity-lead').value = opportunity.lead_id || '';
        document.getElementById('opportunity-assigned-user').value = opportunity.assigned_user_id || '';
        document.getElementById('opportunity-expected-close').value = opportunity.expected_close_date ? opportunity.expected_close_date.split('T')[0] : '';

        // Store the opportunity ID for update
        opportunityForm.dataset.opportunityId = id;

        if (typeof opportunityModal.showModal === 'function') {
            opportunityModal.showModal();
        } else {
            opportunityModal.setAttribute('open', '');
        }
    } catch (error) {
        console.error('Error loading opportunity:', error);
        showAlert('Error loading opportunity', 'error');
    }
}

async function deleteOpportunity(id) {
    if (!confirm('Are you sure you want to delete this opportunity?')) {
        return;
    }

    try {
        const response = await fetch(`/api/opportunities/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showAlert('Opportunity deleted successfully', 'success');
            loadOpportunities();
        } else {
            showAlert('Error deleting opportunity', 'error');
        }
    } catch (error) {
        console.error('Error deleting opportunity:', error);
        showAlert('Error deleting opportunity', 'error');
    }
}

opportunityForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const opportunityData = Object.fromEntries(formData);

    // Convert expected_close_date to ISO format if provided
    if (opportunityData.expected_close_date) {
        opportunityData.expected_close_date = new Date(opportunityData.expected_close_date).toISOString();
    }

    // Convert empty strings to null for optional fields
    Object.keys(opportunityData).forEach(key => {
        if (opportunityData[key] === '') {
            opportunityData[key] = null;
        }
    });

    const opportunityId = this.dataset.opportunityId;

    try {
        const url = opportunityId ? `/api/opportunities/${opportunityId}` : '/api/opportunities';
        const method = opportunityId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(opportunityData)
        });

        if (response.ok) {
            hideModal();
            showAlert(`Opportunity ${opportunityId ? 'updated' : 'created'} successfully`, 'success');
            loadOpportunities();
        } else {
            showAlert(`Error ${opportunityId ? 'updating' : 'creating'} opportunity`, 'error');
        }
    } catch (error) {
        console.error('Error saving opportunity:', error);
        showAlert('Error saving opportunity', 'error');
    }
});

function showAlert(message, type = 'info') {
    // Simple alert implementation - could be enhanced with better toast notifications
    alert(message);
}
</script>
{% endblock %}
